---
---

#Intro to malware

##Discussing several types of infections

- Zeus
- Conficker
- ZeroAccess
- Cryptolocker




###Zeus

[Zeus Tracker](https://zeustracker.abuse.ch)
- Tries to gather credentials from **Pstore**
  Pstore: Protected storage - storage used by Windows internals to store IE Passwords
- Targets credentials for IE, **POP3**, **FTP**
- Deletes cookies for authenticated web services
  - Added field for bank account number on login page.
- Also hooks DLLS of network services to gain control of network activity. eg:
  - WININET.DLL
  - WS2_32.DLL and WSOCK32.DLL
  - USER32.DLL
- Primary vector was social engineering email containing malicious attachment
  - In 2013 51% of infections were through this type of vector.
- Infosec teams also observed infection by **Drive-by down**
  - Drive-by is when malware is downloaded by a site you momentarily visit without your knowledge (eg in iframes for ads, or during redirect sequence)
  - >400k computers infected last Jan (2014) when a Yahoo ad server was infected and hijacked by a drive-by malware campaign

####Zeus/Zbot Installation
- installs and places files in `%SYSTEM%` or `%UserProfile%\Application Data`
  - 
- Places `.exe` file with various names:
  - eg: `ntos.exe`, `oembios.exe`, `twext.exe`, `sdra64.exe`, `pdfupd.exe`
- Also places a config file in a folder called `lowsec` and config file is given different names depending on version
  - eg: `video.dll`, `sysproc32.sys`, `user.ds`, `ldx.exe` (ext may vary)
  - configuration file allows deployment of different modules depending on needs; does not require rewriting code.
  - Helps to prevent control server from being the SPF; config file can be changed to communicate with a new controller

####Zeus/Zbot modification of compromised systems
- Add new registry keys
  - `HKLM\SOFTWARE\Ms\WinNT\CV\WinLogon\"Userinit"= "%System%\userinit.exe, %System%\sdra64.exe"`
  - `HKCU\SW\MS\WIN\CV\Run\"userinit" = "%UserProfile%\Application Data\sdra64.exe"`
- Inject code to `winlogon.exe`, `svchost.exe` etc to gain privilege escalation
- Creates **mutexes** `_ARIVA_2109` and `_ARIVA_2108` so its components can communicate between themselves to practice synchro when accessing shared info
  - synchronize between simultaneous infections; lockout other attackers
- opens back door to the C&C server
  - receives updated of config file and payloads so it can execute attacker's orders
- Also sends C&C server identifying data:
  - bot ID string
  - name of botnet
  - version of the bot
  - OS version
  - OS language
  - local time of compromised computer
  - Uptime of bot
  - last report time
  - country of compromised computer
  - IP addr of compromised computer

*Aside:* Do not trust `Doctor web` -- "I think they're just idiots"

### Conficker

*Recommendation:* Go and read online about this; it's really interesting.

- Discovered in late 2008
- Conficker was one of the most famous malware infections
  - Spread a lot and infected millions of hosts around the wold
  - Had a lot of versions that always kept being updated
  - Used big amount of techniques and had great capability to attack many targets
  - Had a way into public attention(read about the 1st April campaign)
  - The only malware that tMS patched outside of normal patch cycle.
- Had many version sand was always updated against bugs and vulnerabilities.

####Conficker operations
- Did not have dediated operation that could do but rather would download DLL files and ~lunch~ *launch* them.
  
#### Means of spread
- Heavily used autoun features; copies itslef to autorun.inf files in loadable drivers to infect other hosts
- Conficker uses a vuln in win server services to cause **remote code execution** and gain ctrl over vuln procs
- Infects shared folders over network
  - Uses the **NetServerEnum** function to discover all the serers in the local networks and tries to infect them all
  - Usees brute-force attempts to crack users services and hosts with easy passwords
- Conficker had many versions; some were dedicated to infiltrate system and download and install other conficker versions and suicide after
- Puts many executables and dll files in different directores eg:
  - Temp
  - ProgFiles\InternetExplorer
  - System
- Conficker changed and added many new randomly generated keys in registry
- Deleted registry keys to disable windows security center notifications and the autorun parameter for Windows Defender
  - `HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot`
-when infecting a machine it patches the OS against the vulnerability used to prevent other malware infiltrating through it and damaging Conficker's operation
- Blocks domains related to well known security websites (hosts file)
- code encrypted several ways to avoid reverse engineering
  - Which encryption methods were used?
- Blocks windows update process

#### Communication with C&C servers
- had engine to generate 250-50k domain names each day (invented [`DGA`](http://en.wikipedia.org/wiki/Domain_generation_algorithm))
  - Such a huge list of generated domains is hard to block
- makes connection to legit domains that return the ip address of machine like:
  - checkip.dyndns.com
  - checkip.dyndns.org
  - www.findmyip.com
  - www.findmyipaddress.com
- Used P2P networkd to reach C&C and was very hard to take down
  - no central point of attack
  - Peers could update each other with no need to contact main C&C server
- Still unknown who made it
  - Some suspicions since it initially would not infect computers with Ukrainian keyboard layout.
- No actual malicious behavior -- didn't execute its payloads or steal any data

### ZeroAccess




###CryptoLocker

One of the latest/newest/hottest trends in malware: Ransomware
  Ransomware encrypts your machine and holds it hostage unless you pay up. Claims your machine will be decrypted then.
  Often the code is poor quality and easy to decrypt with enough analysis -- not the case with CryptoLocker
Used Wikipedia DGA code to generate 1k domains/day and only 1-2 were registered

**Sinkhole**: register a domain name that a malware uses, and then use that server to track the victim machines because they are contacting that server